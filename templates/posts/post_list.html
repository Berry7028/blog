{% extends "base.html" %}

{% block title %}Posts | Blog{% endblock %}

{% block content %}
  <div class="layout">
    <section class="main">
      <div class="page-row">
        <h1 class="page-title">
          {% if active_category %}{{ active_category.name }}
          {% elif active_tag %}{{ active_tag.name }}
          {% else %}投稿一覧{% endif %}
        </h1>
        {% if user.is_authenticated %}
          <a class="btn" href="{% url 'posts:post_create' %}">新規投稿</a>
        {% endif %}
      </div>

      <!-- カテゴリーバー -->
      <div class="category-bar">
        <a href="{% url 'posts:post_list' %}" class="category-btn {% if not active_category and not active_tag %}active{% endif %}">
          すべて
        </a>
        {% for category in categories %}
          <a href="{{ category.get_absolute_url }}" class="category-btn {% if active_category.slug == category.slug %}active{% endif %}">
            {{ category.name }}
          </a>
        {% endfor %}
      </div>

      {% for post in posts %}
        <article class="card">
          {% if post.image %}
            <div class="card-image">
              <a href="{{ post.get_absolute_url }}">
                <img src="{{ post.image.url }}" alt="{{ post.title }}">
              </a>
            </div>
          {% endif %}
          <div class="card-content">
            <h2 class="card-title">
              <a href="{{ post.get_absolute_url }}">{{ post.title }}</a>
            </h2>
            {% if post.excerpt %}
              <p class="excerpt">{{ post.excerpt }}</p>
            {% endif %}
            <div class="meta">
              {% if post.author %}
                <span>{{ post.author.username }}</span>
              {% endif %}
              {% if post.published_at %}
                <span>{{ post.published_at|date:"Y年m月d日" }}</span>
              {% endif %}
              {% if post.body %}
                <span>{% widthratio post.body|length 500 1 %}分</span>
              {% endif %}
            </div>
            <div class="tags">
              {% for tag in post.tags.all %}
                <a class="tag" href="{{ tag.get_absolute_url }}">#{{ tag.name }}</a>
              {% endfor %}
            </div>
          </div>
        </article>
      {% empty %}
        <p>まだ投稿がありません。</p>
      {% endfor %}

      {% include "partials/pagination.html" %}
    </section>

    <aside class="sidebar">
      <!-- トレンドトピックウィジェット -->
      <div class="panel trending-topics">
        <h3>トレンドトピック</h3>
        {% for tag in tags|slice:":4" %}
          <div class="topic-item">
            <a href="{{ tag.get_absolute_url }}">{{ tag.name }}</a>
            <span class="topic-count">{{ tag.posts.count }}</span>
          </div>
        {% empty %}
          <p class="muted">トピックがありません</p>
        {% endfor %}
      </div>

      <!-- カテゴリーパネル（オプション） -->
      <div class="panel">
        <h3>カテゴリ</h3>
        <ul>
          {% for c in categories %}
            <li>
              <a href="{{ c.get_absolute_url }}">{{ c.name }}</a>
            </li>
          {% empty %}
            <li>なし</li>
          {% endfor %}
        </ul>
      </div>
    </aside>
  </div>
{% endblock %}
